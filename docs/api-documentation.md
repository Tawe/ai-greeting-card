# API Documentation

Complete API reference for the AI Holiday Card Platform.

## Base URL

```
Production: https://yourdomain.com
Development: http://localhost:3000
```

## Authentication

Most endpoints are public and don't require authentication. Rate limiting is enforced via IP and device tracking.

The cleanup endpoint (`POST /api/cleanup`) optionally requires a Bearer token if `CLEANUP_AUTH_TOKEN` is set.

## Rate Limiting

All endpoints are subject to rate limiting:

- **IP-based**: 10 requests per IP per 24 hours (configurable via `RATE_LIMIT_IP_MAX`)
- **Device-based**: 3 requests per device per 24 hours (configurable via `RATE_LIMIT_DEVICE_MAX`)

Rate limit information is included in response headers:
- `X-RateLimit-IP-Limit`: Maximum requests per IP
- `X-RateLimit-IP-Remaining`: Remaining requests for IP
- `X-RateLimit-IP-Reset`: Timestamp when IP limit resets
- `X-RateLimit-Device-Limit`: Maximum requests per device
- `X-RateLimit-Device-Remaining`: Remaining requests for device
- `X-RateLimit-Device-Reset`: Timestamp when device limit resets

When rate limit is exceeded, the API returns `429 Too Many Requests` with details in the response body.

---

## Endpoints

### Create Card

Create a new holiday card with AI-generated content.

**Endpoint:** `POST /api/cards`

**Request Body:**
```json
{
  "occasion": "christmas",
  "vibe": "warm",
  "message": "Happy holidays to my family!"
}
```

**Parameters:**
- `occasion` (string, required): Occasion ID (e.g., "christmas")
- `vibe` (string, required): Card vibe - one of: `"warm"`, `"funny"`, `"fancy"`, `"chaotic"`
- `message` (string, required): User's original message (3-5000 characters)

**Response:** `200 OK`
```json
{
  "id": "abc123xyz",
  "slug": "XyZ9aB",
  "occasion": "christmas",
  "vibe": "warm",
  "cleanMessage": "Wishing you and your family a wonderful holiday season filled with joy and warmth!",
  "coverImageUrl": "https://storage.example.com/cards/abc123xyz/cover-1.png",
  "status": "draft"
}
```

**Error Responses:**

- `400 Bad Request`: Missing or invalid fields
  ```json
  {
    "error": "Missing required fields: occasion, vibe, message"
  }
  ```

- `400 Bad Request`: Invalid vibe
  ```json
  {
    "error": "Invalid vibe. Must be one of: warm, funny, fancy, chaotic"
  }
  ```

- `400 Bad Request`: Content moderation failure
  ```json
  {
    "error": "Content moderation failed",
    "message": "Your message could not be processed. Please revise and try again."
  }
  ```

- `429 Too Many Requests`: Rate limit exceeded
  ```json
  {
    "error": "Rate limit exceeded",
    "message": "Too many requests. Please try again later.",
    "resetAt": "2024-01-02T00:00:00Z"
  }
  ```

- `503 Service Unavailable`: AI service overloaded
  ```json
  {
    "error": "AI service is temporarily overloaded. Please try again in a few moments."
  }
  ```

- `500 Internal Server Error`: Server error
  ```json
  {
    "error": "Failed to create card"
  }
  ```

**Notes:**
- Content moderation automatically removes PII (emails, phone numbers, addresses)
- Content moderation blocks hate speech, harassment, threats, and defamatory statements
- Messages are rewritten by AI to match the selected vibe and occasion
- Cover images are generated by AI based on vibe and occasion
- Cards are created in `draft` status and expire after 30 days (configurable)

---

### Regenerate Cover Image

Regenerate the cover image for a draft card.

**Endpoint:** `POST /api/cards/{id}/regenerate-cover`

**Path Parameters:**
- `id` (string, required): Card ID

**Request Body:** None

**Response:** `200 OK`
```json
{
  "coverImageUrl": "https://storage.example.com/cards/abc123xyz/cover-1234567890.png"
}
```

**Error Responses:**

- `404 Not Found`: Card doesn't exist
  ```json
  {
    "error": "Card not found"
  }
  ```

- `400 Bad Request`: Card is already published
  ```json
  {
    "error": "Cannot regenerate cover for published card"
  }
  ```

- `500 Internal Server Error`: Regeneration failed
  ```json
  {
    "error": "Failed to regenerate cover"
  }
  ```

**Notes:**
- Only works for cards in `draft` status
- Old cover image is kept (not deleted) for history
- New image uses timestamp-based versioning

---

### Regenerate Message

Regenerate the AI-rewritten message for a draft card.

**Endpoint:** `POST /api/cards/{id}/regenerate-message`

**Path Parameters:**
- `id` (string, required): Card ID

**Request Body:**
```json
{
  "originalMessage": "Happy holidays!" // Optional - uses card's current message if not provided
}
```

**Response:** `200 OK`
```json
{
  "cleanMessage": "Wishing you a season filled with warmth, joy, and cherished moments!"
}
```

**Error Responses:**

- `404 Not Found`: Card doesn't exist
  ```json
  {
    "error": "Card not found"
  }
  ```

- `400 Bad Request`: Card is already published
  ```json
  {
    "error": "Cannot regenerate message for published card"
  }
  ```

- `500 Internal Server Error`: Regeneration failed
  ```json
  {
    "error": "Failed to regenerate message"
  }
  ```

**Notes:**
- Only works for cards in `draft` status
- If `originalMessage` is not provided, uses the card's current `cleanMessage`
- Message is regenerated with the same vibe and occasion

---

### Publish Card

Publish a draft card and generate its shareable deep link.

**Endpoint:** `POST /api/cards/{id}/publish`

**Path Parameters:**
- `id` (string, required): Card ID

**Request Body:** None

**Response:** `200 OK`
```json
{
  "id": "abc123xyz",
  "slug": "XyZ9aB",
  "deepLink": "https://yourdomain.com/c/christmas/XyZ9aB",
  "status": "published"
}
```

**Error Responses:**

- `404 Not Found`: Card doesn't exist
  ```json
  {
    "error": "Card not found"
  }
  ```

- `500 Internal Server Error`: Publishing failed
  ```json
  {
    "error": "Failed to publish card"
  }
  ```

**Notes:**
- Changes card status from `draft` to `published`
- Once published, cover and message cannot be regenerated
- Deep link format: `/c/{occasion}/{slug}`

---

### View Card (SSR)

View a published card. This is a server-side rendered page, not an API endpoint.

**Endpoint:** `GET /c/{occasion}/{slug}`

**Path Parameters:**
- `occasion` (string, required): Occasion ID (e.g., "christmas")
- `slug` (string, required): Card slug

**Query Parameters:**
- `src` (string, optional): Attribution source (e.g., "linkedin", "twitter")

**Response:** HTML page with card view

**Error Responses:**

- `404 Not Found`: Card doesn't exist or is not published
- `410 Gone`: Card has expired

**Notes:**
- Only accessible for published cards
- Expired cards show an expiration message
- Includes Open Graph and Twitter Card metadata for social sharing
- Attribution query param (`?src=linkedin`) is tracked for analytics

---

### Cleanup Expired Cards

Clean up expired cards (deletes database records and storage images). Intended for cron jobs.

**Endpoint:** `POST /api/cleanup`

**Headers:**
- `Authorization: Bearer {token}` (optional, required if `CLEANUP_AUTH_TOKEN` is set)

**Request Body:** None

**Response:** `200 OK`
```json
{
  "success": true,
  "result": {
    "totalExpired": 5,
    "deleted": 5,
    "errors": 0,
    "errorDetails": [],
    "durationMs": 1234
  }
}
```

**Error Responses:**

- `401 Unauthorized`: Missing or invalid auth token
  ```json
  {
    "error": "Unauthorized"
  }
  ```

- `500 Internal Server Error`: Cleanup failed
  ```json
  {
    "success": false,
    "error": "Error message"
  }
  ```

**Notes:**
- Deletes cards where `expires_at < NOW()`
- Deletes associated images from storage
- Continues processing even if individual cards fail
- Returns detailed results including error count

---

### Cleanup Health Check

Check if cleanup endpoint is accessible.

**Endpoint:** `GET /api/cleanup`

**Response:** `200 OK`
```json
{
  "message": "Cleanup endpoint is active",
  "endpoint": "/api/cleanup",
  "method": "POST"
}
```

---

## Data Models

### Card

```typescript
{
  id: string;              // Unique card ID (nanoid)
  slug: string;            // URL-friendly slug
  occasionId: string;       // Occasion ID (e.g., "christmas")
  vibe: string;            // Vibe: "warm" | "funny" | "fancy" | "chaotic"
  cleanMessage: string;    // AI-rewritten message
  coverImageUrl: string;   // URL to cover image
  themeVersion: string;    // Theme version (default: "1.0")
  createdAt: Date;         // Creation timestamp
  expiresAt: Date;         // Expiration timestamp (30 days from creation)
  creatorHash: string;     // Hash of IP + user agent
  status: "draft" | "published";
}
```

### Occasion

```typescript
{
  id: string;              // Occasion ID (e.g., "christmas")
  name: string;            // Display name (e.g., "Christmas")
  isActive: boolean;       // Whether occasion is available
  styleGuide: {            // Style guide for AI
    colorPalette: string[];
    motifs: string[];
    tone: string;
  };
  fontSet: string[];       // Fonts for each vibe
  createdAt: Date;
}
```

---

## Error Handling

All errors follow a consistent format:

```json
{
  "error": "Error message",
  "message": "User-friendly message (optional)"
}
```

Common HTTP status codes:
- `200`: Success
- `400`: Bad Request (validation errors)
- `401`: Unauthorized (missing/invalid auth)
- `404`: Not Found
- `429`: Too Many Requests (rate limit exceeded)
- `500`: Internal Server Error
- `503`: Service Unavailable (AI service overloaded)

---

## Rate Limiting Details

Rate limits are enforced per IP address and per device (tracked via cookie/localStorage).

**Headers included in all responses:**
```
X-RateLimit-IP-Limit: 10
X-RateLimit-IP-Remaining: 5
X-RateLimit-IP-Reset: 1704153600000
X-RateLimit-Device-Limit: 3
X-RateLimit-Device-Remaining: 1
X-RateLimit-Device-Reset: 1704153600000
```

**When rate limit is exceeded:**
- Status: `429 Too Many Requests`
- Response includes `resetAt` timestamp
- Both IP and device limits are checked independently

---

## Content Moderation

All user messages are automatically moderated:

1. **PII Removal**: Emails, phone numbers, addresses are removed
2. **Unsafe Content**: Hate speech, harassment, threats are blocked
3. **Defamation**: Defamatory statements about private individuals are blocked
4. **Public Figures**: General mentions allowed, but unsubstantiated criminal accusations blocked
5. **Length**: Messages must be 3-5000 characters

Moderation failures return `400 Bad Request` with a user-friendly error message.

---

## Examples

### Create a Card

```bash
curl -X POST http://localhost:3000/api/cards \
  -H "Content-Type: application/json" \
  -d '{
    "occasion": "christmas",
    "vibe": "warm",
    "message": "Happy holidays to my family!"
  }'
```

### Regenerate Cover

```bash
curl -X POST http://localhost:3000/api/cards/abc123xyz/regenerate-cover
```

### Publish Card

```bash
curl -X POST http://localhost:3000/api/cards/abc123xyz/publish
```

### View Card

```bash
curl http://localhost:3000/c/christmas/XyZ9aB
```

### Cleanup (with auth)

```bash
curl -X POST http://localhost:3000/api/cleanup \
  -H "Authorization: Bearer your-secret-token"
```

---

## Best Practices

1. **Error Handling**: Always check response status codes
2. **Rate Limits**: Monitor rate limit headers and implement exponential backoff
3. **Retries**: Implement retry logic for `503` errors (AI service overloaded)
4. **Validation**: Validate input on client side before sending requests
5. **Content**: Keep messages appropriate and within length limits
6. **Caching**: Cache published card data when possible (they don't change)

---

## Support

For issues or questions:
- Check [Setup Guides](../README.md#setup-guides)
- Review [Environment Variables Documentation](./environment-variables.md)
- See [Specification](./spec.md)
